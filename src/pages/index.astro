---
import { z } from 'zod';
import Layout from '../layouts/Layout.astro';
import { toString } from '../lib/date.ts';

const nodeDataSchema = z.object({
  title: z.string(),
  createdAt: z.string().nullable()
});

const modules = import.meta.glob('/data/*.json', { eager: true });
const pages = Object.entries(modules)
  .map(([path, data]: [string, any]) => {
    const slug = (path.split('/').at(-1) || '').replace(/\.json$/, '');
    const nodeData = nodeDataSchema.parse(data);
    return {
      slug: slug,
      title: nodeData.title,
      createdAt: nodeData.createdAt
    };
  })
  .sort((a, b) => {
    if (!a.createdAt) return 1;
    if (!b.createdAt) return -1;
    return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
  });
---

<Layout>
  <ul>
    {
      pages.map((page) => (
        <li>
          {/* prettier-ignore */}
          <a href={`/${page.slug}`} data-astro-prefetch>{page.title}</a>
          {page.createdAt && (
            <time datetime={page.createdAt}>
              {toString(new Date(page.createdAt))}
            </time>
          )}
        </li>
      ))
    }
  </ul>
</Layout>
