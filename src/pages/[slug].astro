---
import type { Element, ElementContent } from 'hast';
import { toHtml } from 'hast-util-to-html';
import type { ListItem } from 'mdast';
import type { State } from 'mdast-util-to-hast';
import { toHast } from 'mdast-util-to-hast';
import { z } from 'zod';
import Layout from '../layouts/Layout.astro';
import { toString } from '../lib/date.ts';

export async function getStaticPaths() {
  const nodeDataSchema = z.object({
    title: z.string(),
    content: z.any(),
    createdAt: z.string().nullable(),
    updatedAt: z.string().nullable()
  });
  const modules = import.meta.glob('/data/*.json', { eager: true });
  const posts = Object.entries(modules).map(([path, data]) => {
    const slug = (path.split('/').at(-1) || '').replace(/\.json$/, '');
    const nodeData = nodeDataSchema.parse(data);
    return {
      params: { slug },
      props: {
        slug,
        title: nodeData.title,
        content: nodeData.content,
        createdAt: nodeData.createdAt,
        updatedAt: nodeData.updatedAt
      }
    };
  });
  return posts;
}

const { slug, title, content, createdAt, updatedAt } = Astro.props;

// 記事の最初の段落をdescriptionとして使用
const getDescription = (content: any): string => {
  if (content?.children) {
    const firstParagraph = content.children.find(
      (child: any) => child.type === 'paragraph'
    );
    if (firstParagraph?.children) {
      return firstParagraph.children
        .filter((child: any) => child.type === 'text')
        .map((child: any) => child.value)
        .join('')
        .slice(0, 160);
    }
  }
  return title;
};

// カスタムハンドラー: listItem 内の paragraph を unwrap
const handlers = {
  listItem(state: State, node: ListItem): Element {
    const children = node.children || [];
    const result: ElementContent[] = [];

    children.forEach((child) => {
      if (child.type === 'paragraph') {
        // paragraph の中身だけを取り出す
        const converted = state.all(child);
        result.push(...converted);
      } else {
        const converted = state.one(child, node);
        if (converted) {
          if (Array.isArray(converted)) {
            result.push(...converted);
          } else {
            result.push(converted);
          }
        }
      }
    });

    return {
      type: 'element',
      tagName: 'li',
      properties: {},
      children: result
    };
  }
};

const hast = toHast(content, { handlers });
const html = toHtml(hast);
---

<style>
  .article-container {
    container-type: inline-size;

    ul {
      padding-left: 2rem;
    }
  }

  article {
    display: grid;
    grid-template-columns: 180px 1fr;
    grid-template-areas: 'meta body';
    gap: 24px;
    margin-top: 16px;
    h1 {
      margin: 0;
      font-size: x-large;
    }
  }
  .article-content {
    grid-area: body;
    line-height: 1.8;
  }

  footer {
    position: sticky;
    top: 56px;
    height: max-content;
    grid-area: meta;
    dl {
      text-align: right;
      margin: 0;
      color: #555555;
      display: flex;
      flex-direction: column;
      row-gap: 4px;
    }
    dt {
      font-size: smaller;
    }
    dd {
      margin: 0;
    }
  }

  @container (max-width: 840px) {
    article {
      grid-template-columns: none;
      grid-template-rows: auto;
      grid-template-areas: 'meta' 'body';
      row-gap: 4px;
      margin: 8px;
    }

    footer {
      position: initial;
      dl {
        font-size: smaller;
        flex-direction: row;
        justify-content: flex-end;
        column-gap: 16px;
      }
    }
  }
</style>
<Layout title={title} description={getDescription(content)}>
  <div class="article-container">
    <article>
      <div class="article-content">
        <h1>{title}</h1>
        <div set:html={html} />
      </div>
      <footer>
        <dl>
          <div>
            <dt>Created</dt>
            <dd>
              <time datetime={createdAt}
                >{createdAt ? toString(new Date(createdAt)) : '-'}</time
              >
            </dd>
          </div>
          <div>
            <dt>Updated</dt>
            <dd>
              <time datetime={updatedAt}
                >{updatedAt ? toString(new Date(updatedAt)) : '-'}</time
              >
            </dd>
          </div>
        </dl>
      </footer>
    </article>
  </div>
</Layout>
